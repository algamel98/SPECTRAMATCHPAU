# =============================================================================
# SpectraMatch — Apache mod_wsgi Configuration for JPaaS
# =============================================================================
#
# HOW TO APPLY ON JPAAS:
#   1. Open the Jelastic dashboard → your Python environment → Config
#   2. Navigate to:  /etc/httpd/conf.d/  (or /etc/httpd/conf/)
#   3. Find the existing WSGI configuration (often in httpd.conf or wsgi.conf)
#   4. REPLACE the WSGIDaemonProcess / WSGIScriptAlias block with the
#      directives below.
#   5. Restart Apache from the Jelastic dashboard.
#
# These directives CANNOT go in .htaccess — they must be in server config.
# =============================================================================

# --------------------------------------------------------------------------
# 1. GLOBAL INTERPRETER — eliminates NumPy / OpenCV sub-interpreter crashes
# --------------------------------------------------------------------------
# Forces all WSGI apps into the main interpreter, avoiding the
# "NumPy was imported from a Python sub-interpreter" warning and the
# associated memory corruption / "Truncated or oversized response headers"
# crashes.
WSGIApplicationGroup %{GLOBAL}

# --------------------------------------------------------------------------
# 2. DAEMON PROCESS — single process, single thread (serialised requests)
# --------------------------------------------------------------------------
# With ≤5 users/day and heavy CPU-bound image processing, serialising
# requests is the correct trade-off: it guarantees that only ONE request
# is processed at a time, preventing memory exhaustion and worker starvation.
#
# Adjust python-home and python-path to match your JPaaS Python installation.
# Common JPaaS paths:
#   python-home=/opt/jelastic-python311
#   python-path=/var/www/webroot/ROOT
#
WSGIDaemonProcess spectramatch \
    processes=1 \
    threads=1 \
    python-home=/opt/jelastic-python311 \
    python-path=/var/www/webroot/ROOT \
    request-timeout=600 \
    response-timeout=600 \
    socket-timeout=600 \
    connect-timeout=30 \
    queue-timeout=600 \
    startup-timeout=60 \
    deadlock-timeout=660 \
    inactivity-timeout=0 \
    shutdown-timeout=10 \
    graceful-timeout=600 \
    maximum-requests=200 \
    display-name=spectramatch

WSGIProcessGroup spectramatch

# --------------------------------------------------------------------------
# 3. SCRIPT ALIAS — maps / to the WSGI entry point
# --------------------------------------------------------------------------
WSGIScriptAlias / /var/www/webroot/ROOT/wsgi.py

# --------------------------------------------------------------------------
# 4. DIRECTORY PERMISSIONS
# --------------------------------------------------------------------------
<Directory /var/www/webroot/ROOT>
    Require all granted
</Directory>

# --------------------------------------------------------------------------
# 5. APACHE CORE TIMEOUTS
# --------------------------------------------------------------------------
# These must be at least as large as the mod_wsgi response-timeout.
Timeout 600
ProxyTimeout 600
KeepAliveTimeout 65

# --------------------------------------------------------------------------
# 6. MPM CONFIGURATION (prefork — recommended for single-process WSGI)
# --------------------------------------------------------------------------
# If JPaaS allows MPM selection, prefork is simpler and avoids the
# mpm_event thread/sub-interpreter interaction entirely.
# If you cannot change the MPM, the WSGIApplicationGroup %{GLOBAL} directive
# above is sufficient to mitigate the sub-interpreter issue.
#
# <IfModule mpm_prefork_module>
#     StartServers          1
#     MinSpareServers       1
#     MaxSpareServers       1
#     MaxRequestWorkers     2
#     MaxConnectionsPerChild 200
# </IfModule>
#
# <IfModule mpm_event_module>
#     StartServers          1
#     MinSpareThreads       1
#     MaxSpareThreads       2
#     ThreadsPerChild       2
#     MaxRequestWorkers     2
#     MaxConnectionsPerChild 200
# </IfModule>

# --------------------------------------------------------------------------
# TIMEOUT PARAMETER REFERENCE
# --------------------------------------------------------------------------
#
#   request-timeout=600    Max seconds to wait for the *complete* request
#                          (upload + processing + response generation).
#                          For very large images this may need to be 600–900.
#
#   response-timeout=600   Max seconds Apache waits for the WSGI daemon to
#                          start sending response headers.  This is the
#                          directive that triggers "Timeout when reading
#                          response headers" when too low (default 60s).
#
#   socket-timeout=600     Timeout on the Unix socket between Apache and
#                          the WSGI daemon process.
#
#   queue-timeout=600      Max seconds a request can wait in the queue
#                          before being dispatched to a worker (relevant
#                          when processes=1 threads=1 and a request is
#                          already being processed).
#
#   deadlock-timeout=660   Time after which a stuck daemon is forcibly
#                          killed.  Set slightly above response-timeout
#                          to give the process a chance to finish.
#
#   startup-timeout=60     Max seconds for the daemon to initialise.
#                          Heavy imports (OpenCV, NumPy) need ~15–30s on
#                          cold start; 60s provides comfortable margin.
#
#   inactivity-timeout=0   Disabled (0).  Prevents the daemon from being
#                          recycled during quiet periods, which would
#                          force another slow cold start on the next request.
#
#   maximum-requests=200   Recycle the daemon after 200 requests to recover
#                          any leaked memory.  With ≤5 users/day this
#                          triggers rarely.
#
#   graceful-timeout=600   Time allowed for in-flight requests to finish
#                          when the daemon is being recycled or restarted.
# --------------------------------------------------------------------------
