# =============================================================================
# SpectraMatch — NGINX Reverse Proxy Timeouts for JPaaS
# =============================================================================
#
# HOW TO APPLY ON JPAAS:
#   1. Open the Jelastic dashboard → your NGINX load-balancer node → Config
#   2. Navigate to:  /etc/nginx/nginx.conf  (or the relevant server block)
#   3. ADD or MODIFY the directives below inside the appropriate
#      location / or server { } block.
#   4. Reload NGINX from the Jelastic dashboard.
#
# IMPORTANT: If NGINX times out before Apache finishes, the user sees a
# 504 Gateway Timeout even though Apache is still processing.  NGINX
# timeouts must be >= Apache timeouts.
# =============================================================================

# --- Inside the server { } or location / { } block ---

# Time to wait for the upstream (Apache) to start sending response headers.
# Must be >= mod_wsgi response-timeout (600s).
proxy_read_timeout 660s;

# Time to wait for a connection to Apache to be established.
proxy_connect_timeout 30s;

# Time to wait while sending the request body (image upload) to Apache.
proxy_send_timeout 600s;

# Allow large file uploads (match Flask MAX_CONTENT_LENGTH = 100MB).
client_max_body_size 110m;

# Buffer settings for large responses (PDF downloads, big JSON).
proxy_buffer_size 16k;
proxy_buffers 8 32k;
proxy_busy_buffers_size 64k;

# Do not buffer the response — stream it directly to the client.
# This prevents NGINX from holding the entire response in memory.
proxy_buffering off;

# Pass real client IP to Apache (for logging).
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_set_header Host $host;

# --- Example full location block ---
#
# location / {
#     proxy_pass         http://127.0.0.1:8080;
#     proxy_read_timeout 660s;
#     proxy_connect_timeout 30s;
#     proxy_send_timeout 600s;
#     client_max_body_size 110m;
#     proxy_buffering off;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#     proxy_set_header Host $host;
# }
